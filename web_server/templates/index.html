<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <title>Document</title>
</head>

<body>
    <div class="container" style="padding-top: 5rem; padding-bottom: 15rem;">
        <h2>Casa Inteligente</h2>
        <ul id="messageHub" class="list-group">

        </ul>
        <br>
        <div id="productTable" class="card-columns">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div style="line-height:20px;">
                                <a class="card-subtitle text-muted">Seguridad casa</a>
                                <br>
                                <h5 class="card-title trend-title">Alarma</h5>
                            </div>
                        </div>
                        <div class="col-6 mt-2">
                            <div id="estadoAlarma" class="mt-2 alert-success mb-0 text-center">
                                Desactivada</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5">
                            <i class="ion ion-md-color-fill" style="font-size: 24px;"></i>
                        </div>
                        <div class="col-4">
                            <i class="ion ion-md-stats" style="font-size: 24px;"></i>
                        </div>
                    </div>
                    <!--<p class="card-text"><small class="text-muted">Last sale 3 mins ago</small></p>-->
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div style="line-height:20px;">
                                <a class="card-subtitle text-muted">Seguridad casa</a>
                                <br>
                                <h5 class="card-title trend-title">Puertas</h5>
                            </div>
                        </div>
                        <div class="col-6 mt-2">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5">
                            <i class="ion ion-md-color-fill" style="font-size: 24px;"></i>
                        </div>
                        <div class="col-4">
                            <i class="ion ion-md-stats" style="font-size: 24px;"></i>
                        </div>
                    </div>
                    <div id="productBrandTable">
                        <div class="row">
                            <div class="col-8 pt-2">
                                <p id="brandName">Puerta principal</p>
                            </div>
                            <div class="col-4">
                                <div id="estadoPuertaPrincipal"
                                    class="mt-2 alert-success mb-0 text-center light-alert-success">Cerrado</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8 pt-2">
                                <p id="brandName">Puerta trasera</p>
                            </div>
                            <div class="col-4">
                                <div id="estadoPuertaTrasera"
                                    class="mt-2 alert-success mb-0 text-center light-alert-success">Cerrado</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8 pt-2">
                                <p id="brandName">Puerta estudio</p>
                            </div>
                            <div class="col-4">
                                <div id="estadoPuertaEstudio"
                                    class="mt-2 alert-success mb-0 text-center light-alert-success">Cerrado</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8 pt-2">
                                <p id="brandName">Ventana A</p>
                            </div>
                            <div class="col-4">
                                <div id="estadoVentanaA"
                                    class="mt-2 alert-success mb-0 text-center light-alert-success">Cerrado</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8 pt-2">
                                <p id="brandName">Ventana B</p>
                            </div>
                            <div class="col-4">
                                <div id="estadoVentanaB"
                                    class="mt-2 alert-success mb-0 text-center light-alert-success">Cerrado</div>
                            </div>
                        </div>
                    </div>
                    <!--<p class="card-text"><small class="text-muted">Last sale 3 mins ago</small></p>-->
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div style="line-height:20px;">
                                <a class="card-subtitle text-muted">Sistema inteligente</a>
                                <br>
                                <h5 class="card-title trend-title">Temperatura</h5>
                            </div>
                        </div>
                        <div class="col-6 mt-2">
                            <div id="estadoTemperatura" class="mt-2 alert-success mb-0 text-center light-alert-warning">
                                Fresco como una lechuga :)</div>
                        </div>
                    </div>
                    <div id="infoTemperatura" class="row">
                        <div class="col-md-auto">
                            <p class="card-text"><small class="text-muted">enfriandome!</small></p>
                        </div>
                        <div class="col-md-auto">
                            <div class="spinner-border ml-auto text-secondary spinner-border-sm" role="status"
                                aria-hidden="true">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div style="line-height:20px;">
                                <a class="card-subtitle text-muted">Sistema inteligente</a>
                                <br>
                                <h5 class="card-title trend-title">Sensor de movimiento</h5>
                            </div>
                        </div>
                        <div class="col-6 mt-2">
                            <div id="estadoSensor" class="mt-2 alert-success mb-0 text-center light-alert-warning">
                                Luz apagada</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5">
                            <i class="ion ion-md-color-fill" style="font-size: 24px;"></i>
                        </div>
                        <div class="col-4">
                            <i class="ion ion-md-stats" style="font-size: 24px;"></i>
                        </div>
                    </div>
                    <p id="textoApagando" class="card-text"><small id="textoApagar" class="text-muted">Apagando en: 10 segundos</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" charset="utf-8">
        $('#infoTemperatura').hide();
        $('#textoApagando').hide();
        var typingTimer;
        var doneTypingInterval = 300;
        var flag = true;
        var msg_t = '';
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var dyn_functions = [];
        socket.on('message', function (msg) {
            var list = msg.split("-");
            console.log(list);
            var counter = 0;
            list.forEach(element => {
                if (counter == 6) {
                    if (element == "0") {
                        clearTimeout(typingTimer);
                        msg_t = 'all ok';
                        typingTimer = setTimeout(doneTyping, doneTypingInterval, element, msg_t);
                        flag = true;
                    } else {
                        clearTimeout(typingTimer);
                        if (flag == true) {
                            msg_t = 'enfriando!';
                            dyn_functions['receive_void_' + counter](element, msg_t);
                            flag = false;
                        }
                    }

                } else {
                    dyn_functions['receive_void_' + counter](element);
                }
                counter += 1;
            });
        });

        function doneTyping(element, msg_t) {
            dyn_functions['receive_void_6'](element, msg_t);
        }

        $("#sendButton").click(function () {
            var message = $("#myInput").val();
            socket.emit("message", message);
            $("#myInput").val("");
        });
        dyn_functions['receive_void_0'] = function (val) {
            if (val == "0") {
                $('#estadoPuertaEstudio').text("Cerrado");
                $('#estadoPuertaEstudio').removeClass('alert-warning').addClass("alert-success");
            } else {
                $('#estadoPuertaEstudio').text("Abierto");
                $('#estadoPuertaEstudio').removeClass('alert-success').addClass("alert-warning");
            }
        }
        dyn_functions['receive_void_1'] = function (val) {
            if (val == "0") {
                $('#estadoVentanaB').text("Cerrado");
                $('#estadoVentanaB').removeClass('alert-warning').addClass("alert-success");
            } else {
                $('#estadoVentanaB').text("Abierto");
                $('#estadoVentanaB').removeClass('alert-success').addClass("alert-warning");
            }

        }
        dyn_functions['receive_void_2'] = function (val) {
            if (val == "0") {
                $('#estadoAlarma').text("Desactivada");
                $('#estadoAlarma').removeClass('alert-danger').addClass("alert-success");
            } else {
                $('#estadoAlarma').text("Encendida");
                $('#estadoAlarma').removeClass('alert-success').addClass("alert-danger");
            }
        }
        dyn_functions['receive_void_3'] = function (val) {
            if (val == "0") {
                $('#estadoPuertaPrincipal').text("Cerrado");
                $('#estadoPuertaPrincipal').removeClass('alert-warning').addClass("alert-success");
            } else {
                $('#estadoPuertaPrincipal').text("Abierto");
                $('#estadoPuertaPrincipal').removeClass('alert-success').addClass("alert-warning");
            }

        }
        dyn_functions['receive_void_4'] = function (val) {
            if (val == "0") {
                $('#estadoPuertaTrasera').text("Cerrado");
                $('#estadoPuertaTrasera').removeClass('alert-warning').addClass("alert-success");
            } else {
                $('#estadoPuertaTrasera').text("Abierto");
                $('#estadoPuertaTrasera').removeClass('alert-success').addClass("alert-warning");
            }
        }
        dyn_functions['receive_void_5'] = function (val) {
            if (val == "0") {
                $('#estadoVentanaA').text("Cerrado");
                $('#estadoVentanaA').removeClass('alert-warning').addClass("alert-success");
            } else {
                $('#estadoVentanaA').text("Abierto");
                $('#estadoVentanaA').removeClass('alert-success').addClass("alert-warning");
            }
        }
        dyn_functions['receive_void_6'] = function (val, msg_t) {
            console.log(msg_t);
            if (val == "0") {
                $('#estadoTemperatura').text("Fresco como una lechuga :)");
                $('#estadoTemperatura').removeClass('alert-warning').addClass("alert-success");
                $('#infoTemperatura').hide();
            } else {
                $('#estadoTemperatura').text("Wow, ¡esta caliente!");
                $('#estadoTemperatura').removeClass('alert-success').addClass("alert-warning");
                $('#infoTemperatura').show();
            }

        }
        dyn_functions['receive_void_7'] = function (val) {
            if (val == "0") {
                $('#estadoSensor').text("Luz apagada");
                $('#estadoSensor').removeClass('alert-warning').addClass("alert-success");
                $('#textoApagando').hide();
            } else {
                $('#estadoSensor').text("Luz encendida");
                $('#estadoSensor').removeClass('alert-success').addClass("alert-warning");
                $('#textoApagando').show();

                asyncCall();
            }


        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        async function asyncCall() {
            var count = 10;
            for (let i = 0; i < 11; i++) {
                $('#textoApagar').text('Apagando en: ' + count + ' segundos');
                console.log(count);
                count -= 1;
                await sleep(1000);
            }
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>